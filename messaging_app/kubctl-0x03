#!/bin/bash
# kubctl-0x03
# Ensure script stops on error
set -e

DEPLOYMENT_FILE="blue_deployment.yaml"
DEPLOYMENT_NAME="blue-deployment"
NAMESPACE="default"
SERVICE_URL="http://<YOUR_SERVICE_URL>"  # Replace with actual service URL

echo "[1/4] Applying deployment update..."
kubectl apply -f "$DEPLOYMENT_FILE"

echo "[2/4] Monitoring rollout status..."
kubectl rollout status deployment/"$DEPLOYMENT_NAME" -n "$NAMESPACE" &

ROLL_PID=$!

echo "[3/4] Testing downtime..."
# Run curl requests in background until rollout finishes
while kill -0 $ROLL_PID 2>/dev/null; do
    if ! curl -s --max-time 1 "$SERVICE_URL" > /dev/null; then
        echo "Downtime detected!"
        exit 1
    fi
    echo -n "."
    sleep 1
done

wait $ROLL_PID

echo
echo "[4/4] Showing updated pods..."
kubectl get pods -n "$NAMESPACE" -o wide

echo "âœ… Rolling update complete with no downtime detected."
